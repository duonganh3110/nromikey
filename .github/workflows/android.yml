name: Build APK (from zip)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: build-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip rsync curl \
            build-essential ccache \
            autoconf automake libtool pkg-config \
            libffi-dev libssl-dev zlib1g-dev \
            libjpeg-dev libpng-dev \
            libltdl-dev \
            cmake ninja-build \
            python3-dev

      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install "cython<3" buildozer

      - name: Cache buildozer/pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.cache/pip
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: Prepare Android SDK (cmdline-tools + build-tools) in HOME
        run: |
          set -eux
          SDKROOT="$HOME/.buildozer/android/platform/android-sdk"
          mkdir -p "$SDKROOT"

          # Download Android cmdline-tools (official)
          curl -L -o cmdline.zip "https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip"
          rm -rf "$SDKROOT/cmdline-tools"
          mkdir -p "$SDKROOT/cmdline-tools"
          unzip -q cmdline.zip -d "$SDKROOT/cmdline-tools"

          mkdir -p "$SDKROOT/cmdline-tools/latest"
          # Zip thường giải nén ra thư mục cmdline-tools/; ta move vào latest/
          if [ -d "$SDKROOT/cmdline-tools/cmdline-tools" ]; then
            mv "$SDKROOT/cmdline-tools/cmdline-tools"/* "$SDKROOT/cmdline-tools/latest/"
            rmdir "$SDKROOT/cmdline-tools/cmdline-tools"
          else
            # fallback
            find "$SDKROOT/cmdline-tools" -maxdepth 1 -mindepth 1 -type d -exec bash -lc 'shopt -s dotglob; mv "$0"/* "'"$SDKROOT"'/cmdline-tools/latest/" || true' {} \;
          fi

          echo "$SDKROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$SDKROOT/platform-tools" >> "$GITHUB_PATH"

          export ANDROID_SDK_ROOT="$SDKROOT"
          export ANDROID_HOME="$SDKROOT"

          # Buildozer bản cũ hay check tools/bin/sdkmanager => tạo shim cho chắc
          mkdir -p "$SDKROOT/tools/bin"
          ln -sf "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" "$SDKROOT/tools/bin/sdkmanager"

          # tránh warning repositories.cfg
          mkdir -p "$HOME/.android"
          touch "$HOME/.android/repositories.cfg"

          # Accept licenses + install packages cần có "aidl"
          yes | sdkmanager --licenses
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

          echo "✅ SDKROOT=$SDKROOT"
          ls -ლა "$SDKROOT/build-tools" || true

      - name: Unzip project
        run: |
          set -eux
          rm -rf work
          mkdir -p work

          ZIP_FILE="$(ls -1 *.zip | head -n 1 || true)"
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ Không thấy file .zip ở gốc repo"
            ls -la
            exit 1
          fi

          echo "✅ Using zip: $ZIP_FILE"
          unzip -q "$ZIP_FILE" -d work

          echo "=== Preview after unzip ==="
          find work -maxdepth 3 -type f | head -n 120

      - name: Build APK
        run: |
          set -eux

          MAIN_PATH="$(find work -type f -name 'main.py' | head -n 1)"
          if [ -z "$MAIN_PATH" ]; then
            echo "❌ Không tìm thấy main.py sau khi unzip"
            find work -maxdepth 5 -type f | head -n 200
            exit 1
          fi

          PROJECT_DIR="$(dirname "$MAIN_PATH")"
          echo "✅ main.py = $MAIN_PATH"
          echo "✅ PROJECT_DIR = $PROJECT_DIR"

          if [ ! -f "$GITHUB_WORKSPACE/buildozer.spec" ]; then
            echo "❌ Không có buildozer.spec ở gốc repo"
            exit 1
          fi

          cp "$GITHUB_WORKSPACE/buildozer.spec" "$PROJECT_DIR/buildozer.spec"

          # Nếu có local recipes (vd pygame-ce), copy vào cạnh main.py
          if [ -d "$GITHUB_WORKSPACE/p4a-recipes" ]; then
            rsync -a "$GITHUB_WORKSPACE/p4a-recipes" "$PROJECT_DIR/"
          fi

          cd "$PROJECT_DIR"

          # check cú pháp (không chặn build)
          python -m compileall -q -f . || true

          # Trỏ SDK về cái SDKROOT writable vừa cài ở HOME
          export APP_ANDROID_SDK_PATH="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT="$APP_ANDROID_SDK_PATH"
          export ANDROID_HOME="$APP_ANDROID_SDK_PATH"

          set -o pipefail
          buildozer -v android debug 2>&1 | tee "$GITHUB_WORKSPACE/buildozer.log"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "==== IMPORTANT LINES (tail) ===="
          grep -nE "ERROR|FAIL|Traceback|Exception|NoRecipe|not found|Aidl|sdkmanager|build-tools|ndk|clang|Cython|Recipe|gradle" buildozer.log | tail -n 220 || true
          echo "==== LAST 350 LINES ===="
          tail -n 350 buildozer.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: buildozer.log

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            work/**/bin/*.apk
