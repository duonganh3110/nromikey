name: Build APK (from zip)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: build-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "34"
      ANDROID_MINAPI: "21"
      BUILD_TOOLS_VERSION: "34.0.0"
      # p4a hay “hợp” với NDK r25b (25.2.9519653) hơn các NDK mới hơn trong nhiều case
      NDK_VERSION: "25.2.9519653"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ✅ Quan trọng: tạo wrapper tools/bin/sdkmanager + tools/bin/avdmanager
      # để Buildozer/p4a không bị “mù” vì nó hay check đường dẫn legacy tools/bin.
      - name: Prepare Android SDK for Buildozer (wrappers + install packages)
        shell: bash
        run: |
          set -euxo pipefail

          SDKROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          echo "SDKROOT=$SDKROOT"
          if [ -z "${SDKROOT:-}" ] || [ ! -d "$SDKROOT" ]; then
            echo "❌ ANDROID_SDK_ROOT/ANDROID_HOME không hợp lệ"
            env | sort
            exit 1
          fi

          # Tìm sdkmanager/avdmanager thật trong cmdline-tools
          REAL_SDKM="$(find "$SDKROOT/cmdline-tools" -type f -path '*/bin/sdkmanager' | sort | tail -n 1 || true)"
          REAL_AVDM="$(find "$SDKROOT/cmdline-tools" -type f -path '*/bin/avdmanager' | sort | tail -n 1 || true)"
          echo "REAL_SDKM=$REAL_SDKM"
          echo "REAL_AVDM=$REAL_AVDM"

          if [ -z "$REAL_SDKM" ]; then
            echo "❌ Không thấy sdkmanager trong $SDKROOT/cmdline-tools"
            find "$SDKROOT" -maxdepth 4 -type f | head -n 200 || true
            exit 1
          fi

          mkdir -p "$SDKROOT/tools/bin" "$SDKROOT/tools"

          # Wrapper sdkmanager ở tools/bin (tránh ln -sf bị same file)
          cat > "$SDKROOT/tools/bin/sdkmanager" <<EOF
          #!/usr/bin/env bash
          exec "$REAL_SDKM" "\$@"
          EOF
          chmod +x "$SDKROOT/tools/bin/sdkmanager"

          # Wrapper avdmanager (p4a đôi khi gọi avdmanager list target)
          if [ -n "$REAL_AVDM" ]; then
            cat > "$SDKROOT/tools/bin/avdmanager" <<EOF
          #!/usr/bin/env bash
          exec "$REAL_AVDM" "\$@"
          EOF
            chmod +x "$SDKROOT/tools/bin/avdmanager"
          fi

          # Stub 'android' tool (đời cũ) để qua check nếu có
          cat > "$SDKROOT/tools/android" <<'EOF'
          #!/usr/bin/env bash
          echo "android tool is deprecated; use sdkmanager/avdmanager." >&2
          exit 0
          EOF
          chmod +x "$SDKROOT/tools/android"

          # PATH cho chắc
          echo "$SDKROOT/platform-tools" >> "$GITHUB_PATH"
          echo "$SDKROOT/tools/bin" >> "$GITHUB_PATH"
          echo "$(dirname "$REAL_SDKM")" >> "$GITHUB_PATH"

          # Accept licenses: tránh fail vì SIGPIPE/Broken pipe
          yes | "$SDKROOT/tools/bin/sdkmanager" --licenses >/dev/null 2>&1 || true

          # Cài packages cần thiết
          "$SDKROOT/tools/bin/sdkmanager" --install \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;${BUILD_TOOLS_VERSION}" \
            "ndk;${NDK_VERSION}" \
            "cmake;3.22.1"

          echo "NDK_DIR=$SDKROOT/ndk/${NDK_VERSION}" >> "$GITHUB_ENV"
          echo "✅ Installed NDK_DIR=$SDKROOT/ndk/${NDK_VERSION}"
          ls -la "$SDKROOT/ndk/${NDK_VERSION}" | head -n 50 || true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip rsync \
            build-essential ccache \
            autoconf automake libtool pkg-config \
            libffi-dev libssl-dev zlib1g-dev \
            libjpeg-dev libpng-dev \
            libltdl-dev \
            python3-dev

      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install "cython<3" buildozer

      # ✅ Tạm thời KHÔNG cache ~/.buildozer cho tới khi build thành công ổn định
      # (cache cũ rất hay kéo theo SDK/NDK lỗi → fail lặp vô tận)
      - name: Cache Gradle (optional)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Unzip project
        shell: bash
        run: |
          set -eux
          rm -rf work
          mkdir -p work

          ZIP_FILE="$(ls -1 *.zip | head -n 1 || true)"
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ Không thấy file .zip ở gốc repo"
            exit 1
          fi

          echo "✅ Using zip: $ZIP_FILE"
          unzip -q "$ZIP_FILE" -d work

          echo "=== Preview after unzip ==="
          find work -maxdepth 3 -type f | head -n 200

      - name: Build APK
        shell: bash
        run: |
          set -euxo pipefail

          # dọn cache buildozer để khỏi dính SDK/NDK cũ
          rm -rf ~/.buildozer || true

          MAIN_PATH="$(find work -type f -name 'main.py' | head -n 1)"
          if [ -z "$MAIN_PATH" ]; then
            echo "❌ Không tìm thấy main.py sau khi unzip"
            exit 1
          fi

          PROJECT_DIR="$(dirname "$MAIN_PATH")"
          echo "✅ main.py = $MAIN_PATH"
          echo "✅ PROJECT_DIR = $PROJECT_DIR"

          if [ ! -f "$GITHUB_WORKSPACE/buildozer.spec" ]; then
            echo "❌ Không có buildozer.spec ở gốc repo"
            exit 1
          fi
          cp "$GITHUB_WORKSPACE/buildozer.spec" "$PROJECT_DIR/buildozer.spec"

          cd "$PROJECT_DIR"

          # Patch buildozer.spec: ép dùng SDK/NDK của runner + bật log_level=2 để thấy lỗi thật
          SDKROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          NDKDIR="${NDK_DIR:-}"
          if [ -z "$NDKDIR" ]; then
            echo "❌ NDK_DIR chưa được set"
            exit 1
          fi

          # helper replace/add key dưới section [app]
          add_or_replace_app () {
            local key="$1" val="$2"
            if grep -qE "^[[:space:]]*${key}[[:space:]]*=" buildozer.spec; then
              sed -i -E "s|^[[:space:]]*${key}[[:space:]]*=.*|${key} = ${val}|g" buildozer.spec
            else
              sed -i -E "/^\[app\][[:space:]]*$/a ${key} = ${val}" buildozer.spec
            fi
          }

          # helper replace/add key dưới section [buildozer]
          add_or_replace_buildozer () {
            local key="$1" val="$2"
            if ! grep -qE "^\[buildozer\]" buildozer.spec; then
              printf "\n[buildozer]\n" >> buildozer.spec
            fi
            if grep -qE "^[[:space:]]*${key}[[:space:]]*=" buildozer.spec; then
              sed -i -E "s|^[[:space:]]*${key}[[:space:]]*=.*|${key} = ${val}|g" buildozer.spec
            else
              sed -i -E "/^\[buildozer\][[:space:]]*$/a ${key} = ${val}" buildozer.spec
            fi
          }

          add_or_replace_buildozer "log_level" "2"

          add_or_replace_app "android.sdk_path" "$SDKROOT"
          add_or_replace_app "android.ndk_path" "$NDKDIR"
          add_or_replace_app "android.api" "${ANDROID_API}"
          add_or_replace_app "android.minapi" "${ANDROID_MINAPI}"
          add_or_replace_app "android.ndk_api" "${ANDROID_MINAPI}"

          echo "=== buildozer.spec (patched) ==="
          sed -n '1,220p' buildozer.spec

          # Check syntax (không chặn build)
          python -m compileall -q -f . || true

          export ANDROID_SDK_ROOT="$SDKROOT"
          export ANDROID_HOME="$SDKROOT"
          export ANDROIDSDK="$SDKROOT"
          export APP_ANDROID_SDK_PATH="$SDKROOT"

          export ANDROID_NDK_HOME="$NDKDIR"
          export ANDROID_NDK_ROOT="$NDKDIR"
          export ANDROIDNDK="$NDKDIR"

          echo "which sdkmanager: $(command -v sdkmanager || true)"
          echo "which avdmanager: $(command -v avdmanager || true)"
          sdkmanager --version || true
          avdmanager --help | head -n 5 || true

          buildozer -v android debug 2>&1 | tee "$GITHUB_WORKSPACE/buildozer.log"

      - name: Show last log lines on failure
        if: failure()
        run: |
          echo "==== GREP IMPORTANT LINES ===="
          grep -nE "ERROR|FAIL|Traceback|Exception|not found|No such file|sdkmanager|avdmanager|android\.sdk|android\.ndk|NDK|Cython|clang|gradle|Aidl|build-tools|platforms" buildozer.log | tail -n 260 || true
          echo "==== LAST 400 LINES ===="
          tail -n 400 buildozer.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: buildozer.log

      - name: Upload APK/AAB
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            work/**/bin/*.apk
            work/**/bin/*.aab
