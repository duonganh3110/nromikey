name: Build APK (from zip)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: build-apk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Cài Android SDK vào /usr/local/lib/android/sdk (runner ubuntu)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Prepare Android SDK for Buildozer (force ONE SDK + install packages)
        shell: bash
        run: |
          set -eux

          SDKROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-/usr/local/lib/android/sdk}}"
          echo "SDKROOT=$SDKROOT"
          if [ ! -d "$SDKROOT" ]; then
            echo "❌ SDKROOT not found: $SDKROOT"
            ls -la /usr/local/lib/android || true
            exit 1
          fi

          # Tìm sdkmanager thật (cmdline-tools)
          SDKM="$(find "$SDKROOT" -type f -name sdkmanager | grep -E '/cmdline-tools/.+/bin/sdkmanager$' | head -n 1 || true)"
          if [ -z "$SDKM" ]; then
            SDKM="$(find "$SDKROOT" -type f -name sdkmanager | head -n 1 || true)"
          fi
          if [ -z "$SDKM" ]; then
            echo "❌ Không tìm thấy sdkmanager trong $SDKROOT"
            find "$SDKROOT" -maxdepth 4 -type f | head -n 200 || true
            exit 1
          fi
          echo "sdkmanager=$SDKM"

          # Add PATH
          echo "$SDKROOT/platform-tools" >> "$GITHUB_PATH"
          echo "$(dirname "$SDKM")" >> "$GITHUB_PATH"

          # Buildozer/p4a đôi khi check tools/bin/sdkmanager (đường dẫn cũ) -> tạo shim (nhưng tránh ln vào chính nó)
          mkdir -p "$SDKROOT/tools/bin"
          TARGET="$SDKROOT/tools/bin/sdkmanager"
          if [ ! -e "$TARGET" ] || [ "$(readlink -f "$TARGET" || true)" != "$(readlink -f "$SDKM" || true)" ]; then
            ln -sf "$SDKM" "$TARGET"
          fi
          chmod +x "$TARGET" || true
          echo "$SDKROOT/tools/bin" >> "$GITHUB_PATH"

          # Accept licenses (tránh fail vì broken pipe)
          set +e
          yes | "$SDKM" --licenses >/dev/null 2>&1
          set -e

          # Cài packages tối thiểu cho buildozer/p4a (có AIDL trong build-tools)
          "$SDKM" --install \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "cmdline-tools;latest" \
            "ndk;25.2.9519653" \
            "cmake;3.22.1"

          NDKROOT="$SDKROOT/ndk/25.2.9519653"
          if [ ! -d "$NDKROOT" ]; then
            echo "❌ NDK not found at $NDKROOT"
            ls -la "$SDKROOT/ndk" || true
            exit 1
          fi

          # Ghim ENV để buildozer/p4a KHÔNG tự đổi SDK path lung tung
          {
            echo "ANDROID_SDK_ROOT=$SDKROOT"
            echo "ANDROID_HOME=$SDKROOT"
            echo "ANDROIDSDK=$SDKROOT"
            echo "APP_ANDROID_SDK_PATH=$SDKROOT"
            echo "ANDROID_NDK_HOME=$NDKROOT"
            echo "ANDROIDNDK=$NDKROOT"
          } >> "$GITHUB_ENV"

          echo "✅ SDKROOT ok: $SDKROOT"
          echo "✅ NDKROOT ok: $NDKROOT"
          ls -la "$SDKROOT/build-tools" || true
          ls -la "$SDKROOT/platforms" || true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip rsync \
            build-essential ccache \
            autoconf automake libtool pkg-config \
            libffi-dev libssl-dev zlib1g-dev \
            libjpeg-dev libpng-dev \
            libltdl-dev \
            python3-dev

      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install "cython<3" buildozer

      - name: Cache Buildozer/Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: Unzip project
        shell: bash
        run: |
          set -eux
          rm -rf work
          mkdir -p work

          ZIP_FILE="$(ls -1 *.zip | head -n 1 || true)"
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ Không thấy file .zip ở gốc repo"
            exit 1
          fi

          echo "✅ Using zip: $ZIP_FILE"
          unzip -q "$ZIP_FILE" -d work

          echo "=== Preview after unzip ==="
          find work -maxdepth 3 -type f | head -n 200

      - name: Build APK
        shell: bash
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROIDSDK: ${{ env.ANDROIDSDK }}
          APP_ANDROID_SDK_PATH: ${{ env.APP_ANDROID_SDK_PATH }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDNDK: ${{ env.ANDROIDNDK }}
        run: |
          set -eux

          MAIN_PATH="$(find work -type f -name 'main.py' | head -n 1)"
          if [ -z "$MAIN_PATH" ]; then
            echo "❌ Không tìm thấy main.py sau khi unzip"
            exit 1
          fi

          PROJECT_DIR="$(dirname "$MAIN_PATH")"
          echo "✅ main.py = $MAIN_PATH"
          echo "✅ PROJECT_DIR = $PROJECT_DIR"

          if [ ! -f "$GITHUB_WORKSPACE/buildozer.spec" ]; then
            echo "❌ Không có buildozer.spec ở gốc repo"
            exit 1
          fi
          cp "$GITHUB_WORKSPACE/buildozer.spec" "$PROJECT_DIR/buildozer.spec"

          if [ -d "$GITHUB_WORKSPACE/p4a-recipes" ]; then
            rsync -a "$GITHUB_WORKSPACE/p4a-recipes" "$PROJECT_DIR/"
          fi

          cd "$PROJECT_DIR"

          # Patch buildozer.spec trong thư mục build (không đụng file gốc repo)
          python - <<'PY'
          import os, configparser
          spec = "buildozer.spec"
          cfg = configparser.ConfigParser()
          cfg.read(spec, encoding="utf-8")
          if "app" not in cfg:
            raise SystemExit("buildozer.spec thiếu [app]")
          app = cfg["app"]

          # ÉP SDK/NDK đúng 1 chỗ (tránh buildozer tự tạo android-sdk rỗng trong .buildozer)
          app["android.sdk_path"] = os.environ["ANDROID_SDK_ROOT"]
          app["android.ndk_path"] = os.environ["ANDROID_NDK_HOME"]
          app["android.api"] = app.get("android.api", "34")
          app["android.minapi"] = app.get("android.minapi", "21")

          # Log mạnh hơn để lần sau còn thấy lỗi thật
          app["log_level"] = app.get("log_level", "2")

          with open(spec, "w", encoding="utf-8") as f:
            cfg.write(f)
          print("✅ patched buildozer.spec: sdk/ndk/api/minapi/log_level")
          PY

          python -m compileall -q -f . || true

          set -o pipefail
          buildozer -v android debug 2>&1 | tee "$GITHUB_WORKSPACE/buildozer.log"

      - name: Show last log lines on failure
        if: failure()
        run: |
          echo "==== GREP IMPORTANT LINES ===="
          grep -nE "ERROR|FAIL|Traceback|Exception|not found|No such file|recipe|sdkmanager|gradle|clang|Cython|Aidl|build-tools|platforms|ndk" buildozer.log | tail -n 260 || true
          echo "==== LAST 350 LINES ===="
          tail -n 350 buildozer.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: buildozer.log

      - name: Upload APK/AAB
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            work/**/bin/*.apk
            work/**/bin/*.aab
