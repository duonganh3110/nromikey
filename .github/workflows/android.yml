name: Build APK (from zip)

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system deps (full)
        run: |
          set -eux
          sudo apt-get update
          # Theo Buildozer docs (Ubuntu 20.04/22.04) + thêm ant/rsync/build-essential
          sudo apt-get install -y --no-install-recommends \
            git zip unzip openjdk-17-jdk python3-pip \
            autoconf libtool pkg-config \
            zlib1g-dev libffi-dev libssl-dev cmake \
            libncurses5-dev libncursesw5-dev libtinfo5 \
            build-essential ccache \
            ant rsync \
            libjpeg-dev libpng-dev
          java -version
          ant -version
          python --version

      - name: Accept Android SDK licenses (hosted SDK)
        run: |
          set -eux
          ANDROID_HOME="/usr/local/lib/android/sdk"
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -f "$SDKMANAGER" ]; then
            SDKMANAGER="$(find "$ANDROID_HOME" -type f -name sdkmanager | head -n 1 || true)"
          fi
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "sdkmanager=$SDKMANAGER"
          yes | "$SDKMANAGER" --licenses || true
          "$SDKMANAGER" --install "platform-tools" "platforms;android-34" "build-tools;34.0.0" || true

      - name: Fix sdkmanager path for p4a (tools/bin)
        run: |
          set -eux
          ANDROID_HOME="/usr/local/lib/android/sdk"
          REAL_SDKMANAGER="$(find "$ANDROID_HOME" -type f -name sdkmanager | head -n 1 || true)"
          if [ -z "$REAL_SDKMANAGER" ]; then
            echo "❌ Không tìm thấy sdkmanager trong $ANDROID_HOME"
            exit 1
          fi
          sudo mkdir -p "$ANDROID_HOME/tools/bin"
          sudo ln -sf "$REAL_SDKMANAGER" "$ANDROID_HOME/tools/bin/sdkmanager"
          "$ANDROID_HOME/tools/bin/sdkmanager" --version || true

      - name: Install Buildozer
        run: |
          set -eux
          python -m pip install --upgrade pip
          pip install "cython<3" buildozer

      - name: Unzip project
        run: |
          set -eux
          rm -rf work
          mkdir -p work

          ZIP_FILE="$(ls -1 *.zip | head -n 1 || true)"
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ Không thấy file .zip ở gốc repo"
            exit 1
          fi

          echo "✅ Using zip: $ZIP_FILE"
          unzip -q "$ZIP_FILE" -d work
          find work -maxdepth 3 -type f | head -n 80

      - name: Build APK (always print error tail)
        run: |
          set -eux

          MAIN_PATH="$(find work -type f -name 'main.py' | head -n 1)"
          if [ -z "$MAIN_PATH" ]; then
            echo "❌ Không tìm thấy main.py sau khi unzip"
            exit 1
          fi

          PROJECT_DIR="$(dirname "$MAIN_PATH")"
          echo "✅ main.py = $MAIN_PATH"
          echo "✅ PROJECT_DIR = $PROJECT_DIR"

          cp "$GITHUB_WORKSPACE/buildozer.spec" "$PROJECT_DIR/buildozer.spec"

          if [ -d "$GITHUB_WORKSPACE/p4a-recipes" ]; then
            rsync -a "$GITHUB_WORKSPACE/p4a-recipes" "$PROJECT_DIR/"
          fi

          cd "$PROJECT_DIR"
          python -m compileall -q -f . || true

          export ANDROID_HOME="/usr/local/lib/android/sdk"
          export ANDROID_SDK_ROOT="$ANDROID_HOME"
          export ANDROIDSDK="$ANDROID_HOME"

          set +e
          set -o pipefail
          buildozer -v android debug 2>&1 | tee "$GITHUB_WORKSPACE/buildozer.log"
          STATUS=${PIPESTATUS[0]}

          echo ""
          echo "================= GREP IMPORTANT LINES ================="
          grep -nE "ERROR|Error:|Exception|Traceback|FAILED|failed|No recipe|Recipe|Command failed" \
            "$GITHUB_WORKSPACE/buildozer.log" | tail -n 120 || true

          echo ""
          echo "================= LAST 250 LINES ================="
          tail -n 250 "$GITHUB_WORKSPACE/buildozer.log" || true

          exit $STATUS

      - name: Upload APK (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            work/**/bin/*.apk

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            buildozer.log
            work/**/.buildozer/**/buildozer.log
            work/**/.buildozer/**/log.txt
            work/**/.buildozer/**
